# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch and riscv
on:
  push:
    branches: [ master, riscv]
  pull_request:
    branches: [ master, riscv]
  release:
    branches: [ master, riscv]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: build-toolchains
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          submodules: "recursive"
        

      # Runs a single command using the runners shell
      - name: Download the x86_64-onyx-linux toolchain
        uses: actions/download-artifact@v2.0.8
        with:
          # Artifact name
          name: x86_64-onyx-linux

      - name: Extract Toolchain
        run: |
          zstd -d x86_64-onyx-linux.tar.zst --stdout | tar x
          echo "$PWD/x86_64-onyx/bin" >> $GITHUB_PATH
  
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install mtools genisoimage libfl2 clang-tidy unzip ninja-build
          mkdir gn_bin/
          cd gn_bin
          wget -q https://chrome-infra-packages.appspot.com/dl/gn/gn/linux-amd64/+/latest -O gn.zip
          unzip gn.zip
          echo "$PWD" >> $GITHUB_PATH
          cd ..

      # Runs a set of commands using the runners shell
      - name: Build Onyx
        run: |
          cp kernel/kernel.config.example kernel/kernel.config
          export SYSROOT=$PWD/sysroot
          export ONYX_ARCH=x86_64
          ./scripts/setup_build.sh
          RUN_CLANG_TIDY=0 make -j $(nproc) iso

      - name: Upload a Build Artifact(Onyx.iso)
        uses: actions/upload-artifact@v2.1.4
        with:
          name: Onyx ISO
          path: Onyx.iso

      - name: Upload a Build Artifact(kernel/vmonyx)
        uses: actions/upload-artifact@v2.1.4
        with:
          name: vmonyx
          path: kernel/vmonyx

      - name: Upload a Build Artifact(sysroot)
        uses: actions/upload-artifact@v2.1.4
        with:
          name: Sysroot
          path: sysroot/
  
  build-llvm:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: build-toolchains
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          submodules: "recursive"
        

      # Runs a single command using the runners shell
      - name: Download the onyx-llvm-linux toolchain
        uses: actions/download-artifact@v2.0.8
        with:
          # Artifact name
          name: onyx-llvm-linux

      - name: Extract Toolchain
        run: |
          zstd -d onyx-llvm-linux.tar.zst --stdout | tar x
  
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install mtools genisoimage libfl2 clang-tidy unzip ninja-build
          mkdir gn_bin/
          cd gn_bin
          wget -q https://chrome-infra-packages.appspot.com/dl/gn/gn/linux-amd64/+/latest -O gn.zip
          unzip gn.zip
          echo "$PWD" >> $GITHUB_PATH
          cd ..

      # Runs a set of commands using the runners shell
      - name: Build Onyx
        run: |
          cp kernel/kernel.config.example kernel/kernel.config
          export CLANG_PATH=$PWD/onyx-llvm
          export SYSROOT=$PWD/sysroot
          export ONYX_ARCH=x86_64
          ./scripts/setup_build.sh
          RUN_CLANG_TIDY=0 make -j $(nproc) iso

      - name: Upload a Build Artifact(Onyx.iso)
        uses: actions/upload-artifact@v2.1.4
        with:
          name: Onyx-iso-llvm
          path: Onyx.iso

      - name: Upload a Build Artifact(kernel/vmonyx)
        uses: actions/upload-artifact@v2.1.4
        with:
          name: vmonyx-llvm
          path: kernel/vmonyx

      - name: Upload a Build Artifact(sysroot-llvm)
        uses: actions/upload-artifact@v2.1.4
        with:
          name: Sysroot-llvm
          path: sysroot/

  build-toolchains:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-18.04, macos-latest]
        target_arch: [x86_64, riscv64]
        toolchain: [gnu, llvm]
        exclude:
          # macOS can't build LLVM just yet
          - os: macos-latest
            toolchain: llvm
          # LLVM should build for all targets, since it's a cross compiler by nature, but right now, it doesn't do that.
          # In fact, there's no onyx llvm port for riscv64 right now.
          - target_arch: riscv64
            toolchain: llvm

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          submodules: "recursive"
      
      - run: |
          # Add a modifier to ubuntu 18.04 LTS    
          if [ "${{ matrix.os }}" = "ubuntu-18.04" ]; then
            os_name_modifier="-ubuntu-18.04"
          fi

          case "${{ runner.os }}" in
          Linux)
            os_name="linux$os_name_modifier"
            ;;
          macOS)
            os_name="macos"
            ;;
          esac

          case "${{ matrix.toolchain }}" in
          gnu)
            toolchain_id_no_os="${{ matrix.target_arch }}-onyx"
            ;;
          llvm)
            toolchain_id_no_os="onyx-llvm"
            ;;
          esac

          echo "os_name=$os_name" >> $GITHUB_ENV
          echo "toolchain_id_no_os=$toolchain_id_no_os" >> $GITHUB_ENV
          echo "toolchain_id=${toolchain_id_no_os}-${os_name}" >> $GITHUB_ENV


      - name: Cache (GNU toolchain)
        if: ${{ matrix.toolchain }} = 'gnu'
        id: toolchain-cache-gnu
        uses: actions/cache@v2.1.4
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: toolchain_binaries-gnu/
          # An explicit key for restoring and saving the cache
          key: ${{ matrix.target_arch }}-toolchain-${{ matrix.os }}-${{ hashFiles('toolchains/binutils-2.35.patch', 'toolchains/gcc-10.2.0.patch',
                'toolchains/scripts/build_toolchain.sh') }}
      
      - name: Cache (LLVM toolchain)
        if: ${{ matrix.toolchain }} = 'llvm'
        id: toolchain-cache-llvm
        uses: actions/cache@v2.1.4
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: toolchain_binaries-llvm/
          # An explicit key for restoring and saving the cache
          key: ${{ matrix.target_arch }}-toolchain-${{ matrix.os }}-${{ hashFiles('toolchains/llvm-project-12.0.0.patch',
                'toolchains/scripts/build_toolchain.sh') }}
  
      - name: Build toolchain
        if: (steps.toolchain-cache-gnu.outputs.cache-hit != 'true' && ${{ matrix.toolchain }} == 'gnu') ||
            (steps.toolchain-cache-llvm.outputs.cache-hit != 'true' && ${{ matrix.toolchain }} == 'llvm')
        run: |
          scripts/ci/install_github_ci_deps.sh
          cp kernel/kernel.config.example kernel/kernel.config
          curl -O https://storage.googleapis.com/onyx-stuffs/minimal-sysroot-${{ matrix.target_arch }}.tar.zst
          zstd -d minimal-sysroot-${{ matrix.target_arch }}.tar.zst -c | tar xvf -
          echo "$PWD/gn_bin" >> $GITHUB_PATH

          if [ "$RUNNER_OS" = "macOS" ]; then
            export PATH="/usr/local/opt/gnu-getopt/bin:$(brew --prefix)/opt/coreutils/libexec/gnubin:$(brew --prefix)/opt/make/libexec/gnubin:$PATH"
          fi

          export SYSROOT=$PWD/sysroot
          export ONYX_ARCH=${{ matrix.target_arch }}
          ./scripts/setup_build.sh
          make install-headers -j 2
          mkdir toolchain_binaries-${{ matrix.toolchain }}
          ./toolchains/scripts/build_toolchain.sh toolchain_build toolchain_binaries-${{ matrix.toolchain }} \
          -a ${{ matrix.target_arch }} --toolchain=${{ matrix.toolchain }}

      - name: Compress toolchain
        run: |
          mv toolchain_binaries-${{ matrix.toolchain }} ${{ env.toolchain_id_no_os }}
          tar cvf ${{ env.toolchain_id }}.tar ${{ env.toolchain_id_no_os }}
          zstd -T0 -13 ${{ env.toolchain_id }}.tar -o ${{ env.toolchain_id }}.tar.zst
          # We move the binaries back to toolchain_binaries-${{ matrix.toolchain }} due to the cache we previously set up
          mv ${{ env.toolchain_id_no_os }} toolchain_binaries-${{ matrix.toolchain }}

      - name: Upload the toolchain
        uses: actions/upload-artifact@v2.1.4
        with:
          name: ${{ env.toolchain_id }}
          path: ${{ env.toolchain_id }}.tar.zst
